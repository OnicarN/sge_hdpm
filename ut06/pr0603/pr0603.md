# PR0603: Campos calculados y restricciones

Debemos dejar el models.py de la siguinete  manera 

```python
from odoo import models, fields, api
from odoo.exceptions import ValidationError

class StockProduct(models.Model):
    _name = 'stock.product'
    _description = 'Producto en Stock'
    _sql_constraints = [
        ('unique_name', 'UNIQUE(name)', 'El nombre del producto debe ser único'),
        ('quantity_positive', 'CHECK(quantity >= 0)', 'La cantidad en stock debe ser mayor o igual a 0'),
        ('name_length', 'CHECK(LENGTH(name) >= 3)', 'El nombre del producto debe tener al menos 3 caracteres'),
        ('unique_name_category', 'UNIQUE(name, category)', 'No se permiten duplicados en la combinación nombre y categoría')
    ]

    # Campos del modelo
    name = fields.Char(string='Nombre', required=True)
    category = fields.Selection([
        ('micro', 'Microprocesadores'),
        ('gpu', 'Tarjetas Gráficas'),
        ('ram', 'Memoria RAM'),
        ('ssd', 'Almacenamiento SSD')
    ], string='Categoría', required=True)
    price = fields.Float(string='Precio Unitario', required=True)
    quantity = fields.Integer(string='Cantidad en Stock', required=True)
    total_value = fields.Float(string='Valor Total', compute='_compute_total_value', store=True)
    minimum_quantity = fields.Integer(string='Cantidad Mínima')
    stock_status = fields.Selection([
        ('normal', 'Normal'),
        ('low', 'Low Stock')
    ], string='Estado de Stock', compute='_compute_stock_status', store=True)
    full_name = fields.Char(string='Nombre Completo', compute='_compute_full_name', store=True)

    # Campos calculados
    @api.depends('price', 'quantity')
    def _compute_total_value(self):
        for record in self:
            record.total_value = record.price * record.quantity

    @api.depends('quantity', 'minimum_quantity')
    def _compute_stock_status(self):
        for record in self:
            record.stock_status = 'low' if record.quantity < record.minimum_quantity else 'normal'

    @api.depends('name', 'category')
    def _compute_full_name(self):
        for record in self:
            category_display = dict(record._fields['category'].selection).get(record.category, '')
            record.full_name = f"{record.name} ({category_display})"

    # Restricciones Python
    @api.constrains('price', 'quantity', 'total_value', 'category')
    def _check_constraints(self):
        for record in self:
            if record.price <= 0:
                raise ValidationError("El precio debe ser mayor que 0")
            if record.quantity < 0:
                raise ValidationError("La cantidad debe ser mayor o igual a 0")
            if record.total_value > 100000:
                raise ValidationError("El valor total del stock no puede superar 100000 unidades monetarias")
            if not record.category:
                raise ValidationError("No se permiten productos sin categoría")
```

Debemos dejar el "views.xml" de la siguiente manera

``` xml
<odoo>
    <!-- Vista Formulario -->
    <record id="view_stock_product_form" model="ir.ui.view">
        <field name="name">stock.product.form</field>
        <field name="model">stock.product</field>
        <field name="arch" type="xml">
            <form string="Producto en Stock">
                <sheet>
                    <group>
                        <field name="name"/>
                        <field name="category"/>
                        <field name="price"/>
                        <field name="quantity"/>
                        <field name="minimum_quantity"/>
                        <field name="total_value" readonly="1"/>
                        <field name="stock_status" readonly="1"/>
                        <field name="full_name" readonly="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista Lista -->
    <record id="view_stock_product_tree" model="ir.ui.view">
        <field name="name">stock.product.tree</field>
        <field name="model">stock.product</field>
        <field name="arch" type="xml">
            <tree string="Productos en Stock">
                <field name="name"/>
                <field name="category"/>
                <field name="price"/>
                <field name="quantity"/>
                <field name="total_value"/>
                <field name="stock_status"/>
            </tree>
        </field>
    </record>

    <!-- Acción para abrir el modelo -->
    <record id="action_stock_products" model="ir.actions.act_window">
        <field name="name">Productos</field>
        <field name="res_model">stock.product</field>
        <field name="view_mode">tree,form</field>
    </record>

    <!-- Menú principal -->
    <menuitem id="menu_stock_management_root" name="stock_management"/>
    <!-- Submenú de productos que apunta a la acción -->
    <menuitem id="menu_stock_products" parent="menu_stock_management_root" name="Productos" action="action_stock_products"/>
</odoo>
```

Queda de la siguiente forma 
![alt text](<Captura de pantalla 2025-12-20 212411.png>)